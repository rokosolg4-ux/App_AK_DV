<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Номенклатура 1С:Предприятие</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #f5f5f5; --panel: #fff; --border: #ccc; --header-yellow: #fff9c4; --active-tab: #fff; --text: #333; }
        body { font-family: 'Arial', sans-serif; background: var(--bg); margin: 0; height: 100vh; display: flex; overflow: hidden; font-size: 13px; }

        /* ЛЕВАЯ ПАНЕЛЬ */
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .sidebar-header { padding: 10px; font-weight: bold; border-bottom: 1px solid var(--border); background: #eee; }
        .folder-list { overflow-y: auto; flex: 1; }
        .folder { padding: 5px 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .folder:hover { background-color: #d1e8ff; }
        .folder.active { background-color: #3399ff; color: white; }

        /* ПРАВАЯ ПАНЕЛЬ (СПИСОК) */
        .main-view { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .grid-header { padding: 10px; background: var(--panel); border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
        .product-table-container { flex: 1; overflow: auto; padding: 10px; }
        
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .p-card { background: var(--panel); border: 1px solid var(--border); padding: 10px; cursor: pointer; border-radius: 3px; }
        .p-card:hover { border-color: #3399ff; background: #f0f8ff; }

        /* === ОКНО 1С (MODAL) === */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 1000; }
        .modal-window { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 95vw; height: 90vh; background: #f2f2f2; border: 1px solid #999; 
            display: flex; flex-direction: column; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        /* Желтая шапка 1С */
        .m-header { background: #fff6d5; padding: 5px 10px; border-bottom: 1px solid #d9d9d9; display: flex; justify-content: space-between; }
        .m-toolbar { background: #fff; padding: 5px; border-bottom: 1px solid #ccc; display: flex; gap: 5px; }
        .btn-1c { 
            background: #fff; border: 1px solid #ccc; padding: 3px 10px; font-size: 12px; cursor: pointer; border-radius: 2px;
        }
        .btn-yellow { background: #ffeb3b; border: 1px solid #d4c013; font-weight: bold; }

        /* Вкладки */
        .tabs { display: flex; background: #f2f2f2; border-bottom: 1px solid #ccc; padding-top: 5px; padding-left: 5px; }
        .tab { padding: 5px 15px; border: 1px solid #ccc; border-bottom: none; background: #e6e6e6; cursor: pointer; margin-right: -1px; border-radius: 3px 3px 0 0; }
        .tab.active { background: #fff; border-top: 2px solid #ff9800; font-weight: bold; position: relative; top: 1px; }

        /* Контент вкладки */
        .tab-body { flex: 1; background: #fff; padding: 15px; overflow-y: auto; border-top: 1px solid #ccc; }
        .t-content { display: none; }
        .t-content.active { display: block; }

        /* Поля ввода */
        .field-row { display: flex; margin-bottom: 8px; align-items: center; }
        .field-label { width: 160px; color: #444; text-align: right; padding-right: 10px; font-size: 12px; }
        .field-input { flex: 1; padding: 4px; border: 1px solid #ccc; font-size: 12px; }
        .field-input[readonly] { background: #f9f9f9; color: #666; }
        
        .group-box { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; position: relative; margin-top: 15px; }
        .group-title { position: absolute; top: -10px; left: 10px; background: #fff; padding: 0 5px; color: #009688; font-weight: bold; }

        /* Таблица внутри вкладки */
        .inner-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 11px; }
        .inner-table th { background: #f2f2f2; border: 1px solid #ccc; padding: 4px; text-align: left; }
        .inner-table td { border: 1px solid #ccc; padding: 4px; background: #fff; }

        .link-text { color: #0066cc; text-decoration: underline; cursor: pointer; margin-left: 10px; font-size: 11px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-header">Номенклатура</div>
        <div class="folder-list" id="folders"></div>
    </div>

    <div class="main-view">
        <div class="grid-header">
            <button class="btn-1c btn-yellow">Создать</button>
            <input type="text" placeholder="Поиск..." style="padding: 3px;">
        </div>
        <div class="product-table-container">
            <div class="product-grid" id="products"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-window">
            <div class="m-header">
                <span id="win-title">Товар (создание)</span>
                <button onclick="closeModal()">X</button>
            </div>
            <div class="m-toolbar">
                <button class="btn-1c btn-yellow">Записать и закрыть</button>
                <button class="btn-1c"><i class="fa fa-floppy-o"></i> Записать</button>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="tab('main', this)">Карточка</div>
                <div class="tab" onclick="tab('desc', this)">Реквизиты</div>
                <div class="tab" onclick="tab('stock', this)">Склад и Цены</div>
                <div class="tab" onclick="tab('paint', this)">Доработки 555</div>
            </div>

            <div class="tab-body">
                
                <div id="tab-main" class="t-content active">
                    <div class="field-row">
                        <label class="field-label">Рабочее наименование:</label>
                        <input type="text" class="field-input" id="inp-name">
                        <i class="fa fa-clone" style="margin-left:5px; color:#aaa;"></i>
                    </div>
                    <div class="field-row">
                        <label class="field-label">Для печати:</label>
                        <input type="text" class="field-input" id="inp-print-name">
                    </div>
                    <div class="field-row">
                        <label class="field-label">Артикул:</label>
                        <input type="text" class="field-input" id="inp-sku" style="width: 100px; flex:none;">
                        <label class="field-label" style="width:50px;">Код:</label>
                        <input type="text" class="field-input" id="inp-code" readonly style="width: 100px; flex:none;">
                        <span class="link-text">Штрихкоды (0)</span>
                    </div>

                    <div class="group-box">
                        <span class="group-title">Основные параметры учета</span>
                        <div class="field-row">
                            <label class="field-label">Вид номенклатуры:</label>
                            <select class="field-input" id="inp-type"><option>Товар</option><option>Услуга</option></select>
                        </div>
                        <div class="field-row">
                            <label class="field-label">Ставка НДС:</label>
                            <input type="text" class="field-input" id="inp-vat" value="20%">
                            <span class="link-text">История</span>
                        </div>
                         <div class="field-row">
                            <label class="field-label">Группа списка:</label>
                            <input type="text" class="field-input" readonly id="inp-cat">
                        </div>
                    </div>

                    <div class="group-box">
                        <span class="group-title">Единицы измерения и условия хранения</span>
                        <div class="field-row">
                            <label class="field-label">Ед. хранения:</label>
                            <input type="text" class="field-input" id="inp-unit" value="шт" style="width:60px; flex:none;">
                            <label class="field-label" style="width:80px;">Ед. отчетов:</label>
                            <input type="text" class="field-input" id="inp-unit-rep" value="шт" style="width:60px; flex:none;">
                        </div>
                        <div class="field-row">
                            <label class="field-label">Вес (кг):</label>
                            <input type="text" class="field-input" id="inp-weight">
                        </div>
                         <div class="field-row">
                            <label class="field-label">Объем (м3):</label>
                            <input type="text" class="field-input" id="inp-vol">
                        </div>
                    </div>

                    <div class="group-box">
                        <span class="group-title">Производитель</span>
                        <div class="field-row">
                            <label class="field-label">Бренд:</label>
                            <input type="text" class="field-input" id="inp-brand">
                        </div>
                        <div class="field-row">
                            <label class="field-label">Страна:</label>
                            <input type="text" class="field-input" id="inp-country">
                        </div>
                    </div>
                </div>

                <div id="tab-desc" class="t-content">
                    <label>Текстовое описание для сайта:</label>
                    <textarea id="inp-desc" style="width:100%; height:200px; margin-top:5px; border:1px solid #ccc;"></textarea>
                    
                    <div style="margin-top:15px;">
                        <input type="checkbox"> Не включать в прайс-лист<br>
                        <input type="checkbox"> Это подарок<br>
                        <input type="checkbox"> Товар снят с производства
                    </div>
                </div>

                <div id="tab-stock" class="t-content">
                    <div class="field-row">
                        <label class="field-label">Мин. остаток:</label>
                        <input type="number" class="field-input" style="width:80px; flex:none; border:1px solid orange;">
                    </div>
                    
                    <h4>Аналоги и Места хранения</h4>
                    <table class="inner-table">
                        <thead>
                            <tr>
                                <th>N</th>
                                <th>Склад</th>
                                <th>Мин. остаток</th>
                                <th>Заказать</th>
                                <th>Ед. изм.</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table-body">
                            </tbody>
                    </table>
                </div>

                <div id="tab-paint" class="t-content">
                    <div class="group-box">
                        <span class="group-title">Формула краски</span>
                        <div class="field-row">
                            <label class="field-label">Коэф. разбавителя:</label>
                            <input type="text" class="field-input" id="inp-thinner">
                        </div>
                        <div class="field-row">
                            <label class="field-label">Коэф. отвердителя:</label>
                            <input type="text" class="field-input" id="inp-hardener">
                        </div>
                         <div class="field-row">
                            <label class="field-label">Матовая добавка:</label>
                            <input type="text" class="field-input">
                        </div>
                    </div>
                    <div style="margin-top:10px;">
                        <input type="checkbox"> Считать как стандарт если меньше 50 гр<br>
                        <input type="checkbox"> Баночка для краски<br>
                        <input type="checkbox"> Не требовать заполнение разбавителя
                    </div>
                </div>

            </div>
            
            <div style="padding:10px; border-top:1px solid #ccc; font-size:11px; color:#666;">
                Ответственный: Администратор | Дата создания: <span id="lbl-date">...</span>
            </div>
        </div>
    </div>

    <script>
        const API = 'http://193.124.9.12:3000/api';

        async function init() {
            // Грузим папки
            const cats = await (await fetch(API + '/categories')).json();
            document.getElementById('folders').innerHTML = cats.map(c => 
                `<div class="folder" onclick="loadStock(${c.id})"><i class="fa fa-folder"></i> ${c.name}</div>`
            ).join('') + `<div class="folder" onclick="loadStock()"><i class="fa fa-folder-open"></i> Все товары</div>`;
            
            loadStock();
        }

        async function loadStock(catId) {
            const url = catId ? `${API}/stock?category=${catId}` : `${API}/stock`;
            const products = await (await fetch(url)).json();
            
            document.getElementById('products').innerHTML = products.map(p => `
                <div class="p-card" onclick="open1CModal(${p.id})">
                    <div style="font-weight:bold; font-size:11px; color:#666;">${p.vendor_code || '---'}</div>
                    <div style="height:30px; overflow:hidden; font-weight:bold; margin-bottom:5px;">${p.product_name}</div>
                    <div style="color:#009688;">${p.price} ₽</div>
                    <div style="font-size:10px;">Ост: ${p.qty}</div>
                </div>
            `).join('');
        }

        async function open1CModal(id) {
            document.getElementById('modal').style.display = 'block';
            
            const p = await (await fetch(`${API}/product/${id}`)).json();
            
            // Заполняем ГЛАВНУЮ
            document.getElementById('win-title').innerText = p.working_name || p.product_name;
            document.getElementById('inp-name').value = p.working_name || p.product_name;
            document.getElementById('inp-print-name').value = p.print_name || p.product_name;
            document.getElementById('inp-sku').value = p.vendor_code || '';
            document.getElementById('inp-code').value = p.internal_code || 'UT-'+p.id;
            
            document.getElementById('inp-vat').value = (p.vat_rate || 20) + '%';
            document.getElementById('inp-unit').value = p.unit_storage || 'шт';
            document.getElementById('inp-unit-rep').value = p.unit_report || 'шт';
            
            document.getElementById('inp-weight').value = p.weight || 0;
            document.getElementById('inp-vol').value = p.volume || 0;
            
            document.getElementById('inp-brand').value = p.brand || '';
            document.getElementById('inp-country').value = p.country || '';
            
            // Заполняем ОПИСАНИЕ
            document.getElementById('inp-desc').value = p.description || '';

            // Заполняем КРАСКУ
            document.getElementById('inp-thinner').value = p.coef_thinner || '0.000';
            document.getElementById('inp-hardener').value = p.coef_hardener || '0.000';

            // Заполняем СКЛАДЫ (Таблица)
            const tbody = document.getElementById('stock-table-body');
            if (p.min_stocks && p.min_stocks.length > 0) {
                tbody.innerHTML = p.min_stocks.map((s, i) => `
                    <tr>
                        <td>${i+1}</td>
                        <td>${s.warehouse_name}</td>
                        <td>${s.min_qty}</td>
                        <td>${s.order_qty}</td>
                        <td>шт</td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Нет данных по мин. остаткам</td></tr>`;
            }

            document.getElementById('lbl-date').innerText = p.created_at || new Date().toLocaleDateString();
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        
        function tab(name, el) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            document.querySelectorAll('.t-content').forEach(c => c.classList.remove('active'));
            document.getElementById('tab-' + name).classList.add('active');
        }

        init();
    </script>
</body>
</html>