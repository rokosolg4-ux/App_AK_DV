<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>РМК | AK.OS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --bg: #0f172a; --glass: rgba(30, 41, 59, 0.9); --accent: #06b6d4; --danger: #ef4444; --success: #10b981; --text: #f8fafc; }
        * { box-sizing: border-box; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: grid; grid-template-columns: 1fr 380px; grid-template-rows: 60px 1fr; gap: 10px; padding: 10px; }
        .panel { background: var(--glass); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; }
        .top { grid-column: 1 / -1; display: flex; justify-content: space-between; align-items: center; }
        .main { display: flex; flex-direction: column; }
        .right { display: flex; flex-direction: column; gap: 15px; }
        
        button { border: none; border-radius: 6px; cursor: pointer; color: #fff; font-weight: bold; transition: 0.2s; }
        .btn-green { background: var(--success); } .btn-red { background: var(--danger); } .btn-blue { background: #3b82f6; }
        .btn-sm { padding: 5px 10px; } .btn-lg { padding: 15px; font-size: 1.2rem; }
        
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #94a3b8; border-bottom: 1px solid #333; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #333; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; z-index: 1000; }
        .modal-box { background: #1e293b; padding: 30px; border-radius: 10px; width: 500px; display: flex; flex-direction: column; gap: 15px; }
        input, select { background: #334155; border: 1px solid #475569; color: #fff; padding: 10px; border-radius: 5px; width: 100%; }
        
        .return-mode { background: #450a0a !important; border-bottom: 2px solid var(--danger); }
        #search-results { position: absolute; bottom: 70px; left: 20px; right: 20px; background: #1e293b; border: 1px solid #334155; max-height: 300px; overflow-y: auto; display: none; }
        .search-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; display: flex; justify-content: space-between; }
        .search-item:hover { background: var(--accent); color: #000; }
    </style>
</head>
<body>

<header class="panel top">
    <div>
        <b style="font-size:1.2rem;">ЧЕК #<span id="ui-id">...</span></b>
        <span id="mode-badge" style="background:var(--success); padding:3px 8px; border-radius:4px; margin-left:10px; color:#000;">ПРОДАЖА</span>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn-sm btn-green" onclick="pos.toggleMode('sale')">ПРОДАЖА</button>
        <button class="btn-sm btn-red" onclick="pos.toggleMode('return')">ВОЗВРАТ</button>
        <select id="sel-client" onchange="pos.setCtx()" style="width:150px;"><option value="">Клиент...</option></select>
        <select id="sel-consultant" onchange="pos.setCtx()" style="width:150px; border-color:var(--danger);"><option value="">Продавец!</option></select>
        <button class="btn-sm" onclick="pos.closeShift()">Z-ОТЧЕТ</button>
    </div>
</header>

<main class="panel main">
    <div style="flex:1; overflow-y:auto;">
        <table>
            <thead><tr><th>Товар</th><th>Цена</th><th>Кол</th><th>Сумма</th><th></th></tr></thead>
            <tbody id="list"></tbody>
        </table>
    </div>
    <div style="position: relative; margin-top: 10px; display: flex; gap: 10px;">
        <input id="scan" type="text" placeholder="Штрихкод / Поиск (F2)..." autofocus>
        <button class="btn-blue btn-sm" onclick="pos.openCatalog()">КАТАЛОГ</button>
        <div id="search-results"></div>
    </div>
</main>

<aside class="panel right">
    <div style="text-align: right;">
        <div style="font-size:3rem; font-weight:bold; color:var(--success);" id="total">0.00</div>
        <div>Бонусы: <b id="bon-used">0</b></div>
        <div id="bon-proj" style="font-size:0.9rem;"></div>
    </div>
    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;">
        Баланс клиента: <b id="cli-bal">0</b>
        <div style="display:flex; gap:5px; margin-top:5px;">
            <input id="inp-bon" type="number" placeholder="Списать...">
            <button class="btn-sm btn-blue" onclick="pos.applyBonus()">OK</button>
        </div>
    </div>
    <button class="btn-lg btn-blue" onclick="pos.payModal()">ОПЛАТА (F6)</button>
</aside>

<div id="mod-shift" class="modal">
    <div class="modal-box" style="text-align: center;">
        <h2>СМЕНА ЗАКРЫТА</h2>
        <input id="start-cash" type="number" placeholder="Сумма в кассе">
        <button class="btn-lg btn-green" onclick="pos.openShift()">ОТКРЫТЬ СМЕНУ</button>
    </div>
</div>

<div id="mod-pay" class="modal">
    <div class="modal-box">
        <h2>ОПЛАТА</h2>
        <div style="display:flex; justify-content:space-between; font-size:1.2rem;">
            <span>Надо: <b id="p-left">0</b></span>
            <span style="color:var(--success)">Сдача: <b id="p-change">0</b></span>
        </div>
        <input id="p-amount" type="number" placeholder="Сумма..." style="font-size:2rem; text-align:right;">
        <div style="display:flex; gap:10px;">
            <button class="btn-lg btn-green" style="flex:1" onclick="pos.addPay('cash')">НАЛ</button>
            <button class="btn-lg btn-blue" style="flex:1" onclick="pos.addPay('card')">КАРТА</button>
        </div>
        <div id="pay-list" style="max-height:100px; overflow-y:auto;"></div>
        <button id="btn-fisc" class="btn-lg" disabled onclick="pos.fiscalize()">ЗАКРЫТЬ ЧЕК</button>
        <button class="btn-sm" onclick="document.getElementById('mod-pay').style.display='none'">ОТМЕНА</button>
    </div>
</div>

<div id="mod-cat" class="modal">
    <div class="modal-box" style="width:800px; height:80vh;">
        <div style="display:flex; justify-content:space-between;"><h2>КАТАЛОГ</h2> <button onclick="document.getElementById('mod-cat').style.display='none'">X</button></div>
        <input type="text" oninput="pos.search(this.value)" placeholder="Поиск...">
        <div style="flex:1; overflow-y:auto;"><table><tbody id="cat-list"></tbody></table></div>
    </div>
</div>

<script>
class POS {
    constructor() {
        this.api = '/api/pos';
        this.r = null;
        this.tmr = null;
        this.fillSelects();
        this.checkShift();
        
        document.addEventListener('keydown', e => {
            if(e.key === 'F2') { e.preventDefault(); this.openCatalog(); }
            if(e.key === 'F6') { e.preventDefault(); this.payModal(); }
        });
        const scan = document.getElementById('scan');
        scan.addEventListener('keypress', e => { if(e.key==='Enter') this.scan(scan.value); });
        scan.addEventListener('input', e => this.liveSearch(e.target.value));
    }

    fillSelects() {
        // MOCK DATA (В реальности грузить с сервера)
        const cl = document.getElementById('sel-client');
        const co = document.getElementById('sel-consultant');
        [{id:1, n:'Частник'}, {id:2, n:'Автосервис'}].forEach(x => cl.add(new Option(x.n, x.id)));
        [{id:1, n:'Иванов'}, {id:2, n:'Петров'}].forEach(x => co.add(new Option(x.n, x.id)));
    }

    async req(ep, body={}) {
        const res = await fetch(this.api + ep, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const data = await res.json();
        if(!res.ok) { alert(data.error); throw data.error; }
        if(data.id) { this.r = data; this.render(); }
        return data;
    }

    async checkShift() {
        const s = await (await fetch(this.api + '/shift/status')).json();
        document.getElementById('mod-shift').style.display = s.status === 'closed' ? 'flex' : 'none';
        if(s.status === 'open' && !this.r) this.req('/create');
    }

    async openShift() { await this.req('/shift/open', { startCash: document.getElementById('start-cash').value }); this.checkShift(); }
    async closeShift() { 
        if(!confirm('Z-Отчет?')) return;
        const res = await this.req('/shift/close');
        alert(`Выручка: ${res.stats.total_sales}`); location.reload();
    }

    scan(sku) { this.req('/add-item', { receiptId: this.r.id, sku, qty: 1 }).then(()=>document.getElementById('scan').value='').catch(()=>{}); }
    
    liveSearch(q) {
        const box = document.getElementById('search-results');
        if(q.length<2) { box.style.display='none'; return; }
        clearTimeout(this.tmr);
        this.tmr = setTimeout(async ()=>{
            const res = await (await fetch(`${this.api}/products/search?q=${q}`)).json();
            box.innerHTML = '';
            if(!res.length) return;
            res.forEach(p => {
                const d = document.createElement('div');
                d.className = 'search-item';
                d.innerHTML = `<span>${p.name}</span><b>${p.price}</b>`;
                d.onclick = () => { this.req('/add-item', {receiptId: this.r.id, sku: p.sku, qty: 1}); box.style.display='none'; document.getElementById('scan').value=''; };
                box.appendChild(d);
            });
            box.style.display = 'block';
        }, 300);
    }

    render() {
        if(!this.r) return;
        const r = this.r;
        document.getElementById('ui-id').innerText = r.id.substring(0,6);
        const bdg = document.getElementById('mode-badge');
        const hdr = document.querySelector('header');
        if(r.type === 'return') { bdg.innerText='ВОЗВРАТ'; bdg.style.background='#ef4444'; hdr.className='panel top return-mode'; }
        else { bdg.innerText='ПРОДАЖА'; bdg.style.background='#10b981'; hdr.className='panel top'; }

        document.getElementById('list').innerHTML = r.items.map(i => `<tr><td>${i.product_name}</td><td>${i.base_price}</td><td>${i.quantity}</td><td>${i.row_total}</td><td><button class="btn-sm btn-red" onclick="pos.delItem(${i.product_id})">X</button></td></tr>`).join('');
        
        document.getElementById('total').innerText = r.final_total;
        document.getElementById('bon-used').innerText = r.bonus_used;
        document.getElementById('cli-bal').innerText = r.client_bonus_balance || 0;
        
        const proj = document.getElementById('bon-proj');
        if(r.client_id) proj.innerHTML = r.type==='sale' ? `<span style="color:#10b981">+${r.bonus_accrued} баллов</span>` : `<span style="color:#ef4444">${r.bonus_accrued} баллов</span>`;
        else proj.innerHTML='';

        // Update Payment Modal if open
        if(document.getElementById('mod-pay').style.display === 'flex') this.renderPay();
    }

    toggleMode(t) { if(confirm('Сбросить чек?')) this.req('/create', {type: t}); }
    delItem(pid) { if(confirm('Удалить?')) this.req('/remove-item', {receiptId: this.r.id, productId: pid}); }
    setCtx() { this.req('/set-context', { receiptId: this.r.id, clientId: document.getElementById('sel-client').value, consultantId: document.getElementById('sel-consultant').value, priceType: 'retail' }); }
    applyBonus() { this.req('/apply-bonus', { receiptId: this.r.id, amount: document.getElementById('inp-bon').value }); }
    
    // PAYMENTS
    payModal() {
        if(!this.r.consultant_id) return alert('Выберите продавца!');
        if(!this.r.items.length) return alert('Чек пуст!');
        document.getElementById('mod-pay').style.display = 'flex';
        this.renderPay();
    }
    renderPay() {
        const r = this.r;
        document.getElementById('p-left').innerText = r.left_to_pay;
        document.getElementById('p-change').innerText = r.change_due;
        const lst = document.getElementById('pay-list');
        lst.innerHTML = r.payments.map(p => `<div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #333;"><span>${p.type}: ${p.amount}</span><button class="btn-sm btn-red" onclick="pos.delPay('${p.id}')">X</button></div>`).join('');
        const btn = document.getElementById('btn-fisc');
        if(r.is_fully_paid) { btn.disabled = false; btn.className='btn-lg btn-green'; }
        else { btn.disabled = true; btn.className='btn-lg disabled'; }
    }
    addPay(type) {
        const val = parseFloat(document.getElementById('p-amount').value);
        let amt = val > 0 ? val : this.r.left_to_pay;
        if(type==='card' && amt > this.r.left_to_pay) return alert('Карта > Остатка');
        this.req('/add-payment', { receiptId: this.r.id, type, amount: amt }).then(()=>document.getElementById('p-amount').value='');
    }
    delPay(id) { if(confirm('Отменить?')) this.req('/remove-payment', { paymentId: id }); }
    fiscalize() {
        this.req('/fiscalize', {receiptId: this.r.id}).then(r => {
            if(r.status==='fiscalized') {
                document.getElementById('mod-pay').style.display='none';
                alert(`ЧЕК ЗАКРЫТ!\nСдача: ${r.change_due}\nНачислено: ${r.bonus_accrued}`);
                this.req('/create');
            }
        });
    }

    // CATALOG
    openCatalog() { document.getElementById('mod-cat').style.display = 'flex'; this.search(''); }
    async search(q) {
        const res = await (await fetch(`${this.api}/products/search?q=${q}`)).json();
        document.getElementById('cat-list').innerHTML = res.map(p => `
            <tr onclick="pos.catAdd('${p.sku}', this)" style="cursor:pointer">
                <td>${p.name}</td><td>${p.price}</td><td>${p.stock}</td><td>+</td>
            </tr>`).join('');
    }
    async catAdd(sku, el) {
        el.style.background = '#10b981';
        await this.req('/add-item', { receiptId: this.r.id, sku, qty: 1 });
        setTimeout(()=>el.style.background='', 300);
    }
}
const pos = new POS();
</script>
</body>
</html>