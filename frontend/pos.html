<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>РМК АВТОКРАСКИ ДВ</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --1c-bg: #f6f6f6; --1c-blue: #2b4b77; --1c-border: #c0c0c0; }
        body { margin: 0; font-family: Arial, sans-serif; background: var(--1c-bg); height: 100vh; display: grid; grid-template-rows: 40px 1fr 60px; }
        
        /* HEADER - Информационная плотность */
        header { background: #fff; border-bottom: 1px solid var(--1c-border); display: flex; align-items: center; padding: 0 15px; gap: 20px; font-size: 12px; }
        .badge { background: #e1f5fe; border: 1px solid #03a9f4; padding: 2px 8px; border-radius: 3px; font-weight: bold; }

        /* TABLE AREA */
        main { display: grid; grid-template-columns: 1fr 300px; gap: 5px; padding: 5px; overflow: hidden; }
        .grid-panel { background: #fff; border: 1px solid var(--1c-border); display: flex; flex-direction: column; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #eee; border: 1px solid var(--1c-border); padding: 5px; font-size: 11px; text-align: left; }
        td { border: 1px solid var(--1c-border); padding: 8px; font-size: 13px; }

        /* SIDEBAR - Расчетный блок */
        .side-panel { display: flex; flex-direction: column; gap: 5px; }
        .card { background: #fff; border: 1px solid var(--1c-border); padding: 10px; }
        .total-display { margin-top: auto; background: #fff; border: 2px solid var(--1c-blue); padding: 15px; text-align: right; }
        .total-price { font-size: 2.2rem; font-weight: bold; color: var(--1c-blue); }

        /* FOOTER - Управление */
        footer { background: #fff; border-top: 1px solid var(--1c-border); display: flex; align-items: center; padding: 0 10px; gap: 10px; }
        #scan-input { flex: 1; padding: 10px; font-size: 16px; border: 1px solid var(--1c-blue); }
        .btn-1c { background: #fff; border: 1px solid var(--1c-border); padding: 10px 15px; font-size: 12px; cursor: pointer; font-weight: bold; }
        .btn-1c:hover { background: #e0e0e0; }
        
        .search-results { position: absolute; bottom: 65px; left: 10px; width: 400px; background: #fff; border: 1px solid var(--1c-blue); box-shadow: 0 -5px 15px rgba(0,0,0,0.2); display: none; }
        .res-item { padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <header>
        <div class="badge">РЕАЛИЗАЦИЯ (НОВЫЙ)</div>
        <div>Организация: <b>ИП Антонюк О. М.</b></div>
        <div>Склад: <b>Шевчука 22 А</b></div>
        <div style="margin-left: auto;">Продавец: <b>Антонюк О. М.</b></div>
    </header>

    <main>
        <div class="grid-panel">
            <div style="flex:1; overflow-y:auto;">
                <table>
                    <thead>
                        <tr><th>Номенклатура</th><th>Кол-во</th><th>Цена</th><th>Сумма</th></tr>
                    </thead>
                    <tbody id="cart-body"></tbody>
                </table>
            </div>
        </div>
        <div class="side-panel">
            <div class="card">
                <div style="font-size: 11px; color: gray;">БОНУСЫ</div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                    <span>К начислению:</span> <b style="color: green;">+ 0.00</b>
                </div>
            </div>
            <div class="total-display">
                <div style="font-size: 11px;">ИТОГО К ОПЛАТЕ:</div>
                <div class="total-price" id="ui-total">0.00 ₽</div>
            </div>
            <button class="btn-1c" style="background: #fbbf24; border: none; height: 50px; font-size: 16px;">ОПЛАТИТЬ</button>
        </div>
    </main>

    <footer>
        <button class="btn-1c">ПОДБОР (F2)</button>
        <div style="position: relative; flex: 1;">
            <input type="text" id="scan-input" placeholder="Поиск товара или штрихкод..." autocomplete="off">
            <div id="search-box" class="search-results"></div>
        </div>
        <button class="btn-1c" style="color: red;">ВОЗВРАТ</button>
    </footer>

    <script>
        const pos = {
            apiUrl: '/api/pos', // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ
            receipt: null,
            async call(ep, body = {}) {
                const res = await fetch(this.apiUrl + ep, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                if(data.id) { this.receipt = data; this.render(); }
            },
            async init() {
                await this.call('/create');
                const inp = document.getElementById('scan-input');
                inp.addEventListener('input', e => this.search(e.target.value));
            },
            async search(q) {
                const box = document.getElementById('search-box');
                if(q.length < 2) { box.style.display = 'none'; return; }
                const res = await fetch(`${this.apiUrl}/products/search?q=${q}`);
                const products = await res.json();
                box.innerHTML = products.map(p => `<div class="res-item" onclick="pos.addItem('${p.sku}')"><span>${p.name}</span><b>${p.price}</b></div>`).join('');
                box.style.display = 'block';
            },
            async addItem(sku) {
                await this.call('/add-item', { receiptId: this.receipt.id, sku, qty: 1 });
                document.getElementById('search-box').style.display = 'none';
                document.getElementById('scan-input').value = '';
            },
            render() {
                document.getElementById('ui-total').innerText = this.receipt.final_total + ' ₽';
                document.getElementById('cart-body').innerHTML = this.receipt.items.map(i => `
                    <tr><td>${i.product_name}<br><small>${i.sku}</small></td><td>${i.quantity}</td><td>${i.base_price}</td><td>${i.row_total}</td></tr>
                `).join('');
            }
        };
        pos.init();
    </script>
</body>
</html>