<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>РМК АВТОКРАСКИ ДВ</title>
    <style>
        :root { --1c-blue: #2b4b77; --1c-bg: #f2f2f2; --1c-border: #c0c0c0; }
        body { margin: 0; font-family: Arial, sans-serif; background: var(--1c-bg); display: flex; flex-direction: column; height: 100vh; }
        header { background: #fff; padding: 10px 20px; border-bottom: 1px solid var(--1c-border); display: flex; gap: 20px; align-items: center; }
        main { flex: 1; display: grid; grid-template-columns: 1fr 300px; padding: 10px; gap: 10px; overflow: hidden; }
        .table-panel { background: #fff; border: 1px solid var(--1c-border); overflow-y: auto; }
        .side-panel { display: flex; flex-direction: column; gap: 10px; }
        .card { background: #fff; border: 1px solid var(--1c-border); padding: 15px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #e0e0e0; padding: 8px; border: 1px solid var(--1c-border); text-align: left; font-size: 12px; }
        td { padding: 8px; border: 1px solid var(--1c-border); font-size: 13px; }
        .total-label { font-size: 24px; color: var(--1c-blue); font-weight: bold; text-align: right; }
        footer { height: 60px; background: #fff; border-top: 1px solid var(--1c-border); display: flex; align-items: center; padding: 0 20px; }
        input { padding: 10px; border: 1px solid var(--1c-border); width: 100%; font-size: 16px; }
        .btn-1c { background: #fff; border: 1px solid var(--1c-border); padding: 8px 15px; cursor: pointer; }
        .btn-1c:hover { background: #e0e0e0; }
    </style>
</head>
<body>
    <header>
        <div>Тип: <b id="ui-type">ПРОДАЖА</b></div>
        <div>Клиент: <b>Частное лицо</b></div>
        <div style="margin-left:auto">Продавец: <b>Антонюк О. М.</b></div>
    </header>

    <main>
        <div class="table-panel">
            <table>
                <thead><tr><th>Номенклатура</th><th>Кол-во</th><th>Цена</th><th>Сумма</th></tr></thead>
                <tbody id="rows"></tbody>
            </table>
        </div>
        <div class="side-panel">
            <div class="card">
                <div style="color: gray; font-size: 12px;">БОНУСЫ</div>
                <div id="ui-bonus" style="font-size: 18px; font-weight: bold; color: green;">+ 0.00</div>
            </div>
            <div class="card" style="margin-top: auto;">
                <div style="font-size: 14px;">ИТОГО К ОПЛАТЕ:</div>
                <div class="total-label" id="ui-total">0.00 ₽</div>
            </div>
            <button class="btn-1c" style="background: #ffcc00; height: 50px; font-weight: bold;">ОПЛАТИТЬ</button>
        </div>
    </main>

    <footer>
        <input type="text" id="scan" placeholder="Поиск товара (Enter)..." autofocus>
    </footer>

    <script>
        const pos = {
            apiUrl: '/api/pos', // КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ ДЛЯ IP
            receipt: null,
            async call(ep, body = {}) {
                const res = await fetch(this.apiUrl + ep, { 
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'}, 
                    body: JSON.stringify(body) 
                });
                const data = await res.json();
                if(data.id) { this.receipt = data; this.render(); }
            },
            async init() {
                await this.call('/create', {type: 'sale'});
                document.getElementById('scan').addEventListener('keypress', e => {
                    if(e.key === 'Enter') this.addItem(e.target.value);
                });
            },
            async addItem(sku) {
                await this.call('/add-item', {receiptId: this.receipt.id, sku, qty: 1});
                document.getElementById('scan').value = '';
            },
            render() {
                const r = this.receipt;
                document.getElementById('ui-total').innerText = r.final_total + ' ₽';
                document.getElementById('ui-bonus').innerText = '+ ' + r.bonus_accrued;
                document.getElementById('rows').innerHTML = r.items.map(i => `
                    <tr><td>${i.product_name}</td><td>${i.quantity}</td><td>${i.base_price}</td><td>${i.row_total}</td></tr>
                `).join('');
            }
        };
        pos.init();
    </script>
</body>
</html>